---
name: deep-plan
description: Planner-Critic 듀얼 에이전트로 심층 계획을 수립하고, 가중치 비평 + Hard Gate로 품질을 검증
---

복잡한 기능 구현 전에 **Planner(계획 수립)**와 **Critic(냉혹한 비평)** 2개 에이전트를 활용하여 촘촘한 구현 계획을 수립하고, **가중치 비평 + C6 Hard Gate** 피드백 루프를 통해 계획 품질을 검증합니다.

## 인자
$ARGUMENTS - 구현할 기능/작업에 대한 설명 (필수)

## 사용법
```
/deep-plan 사용자 인증 시스템 구현 (JWT + 세션)
/deep-plan 대시보드 성능 최적화
/deep-plan DB 스키마 마이그레이션 (PostgreSQL → MSSQL)
```

## 언제 사용하는가

| 적합 | 부적합 |
|------|--------|
| 5개+ 파일 수정, 아키텍처 결정 포함 | 단순 버그 수정 (1~2줄) |
| 여러 구현 방법이 가능한 경우 | 명확한 지시가 있는 단일 파일 수정 |
| 신규 모듈/서비스 설계 | 순수 탐색/리서치 작업 |
| 보안/성능 민감한 대규모 변경 | 이미 계획이 확정된 작업 |

> 간단한 작업은 Plan 모드(`EnterPlanMode`)로 충분합니다. `/deep-plan`은 **계획 자체의 품질 검증**이 필요할 때 사용합니다.

---

## 실행 절차

### 0단계: 사전 분석 및 요구사항 정제

1. 사용자의 요청(`$ARGUMENTS`)을 분석하여 **명시적 요구사항**과 **암묵적 요구사항** 분리
2. **작업 유형 태그 자동 분류:**

| 태그 | 해당 조건 | Critic 가중치 영향 |
|------|----------|-------------------|
| `보안` | 인증/인가, 암호화, 접근제어 관련 | C6 가중 ×2.0 |
| `UI` | 프론트엔드 컴포넌트, 스타일링 | C4 가중 ×1.5 |
| `인프라` | Docker, CI/CD, 환경설정 | C1 가중 ×1.5 |
| `데이터` | DB 스키마, 마이그레이션, ORM | C2 가중 ×1.5 |
| `비즈니스` | 핵심 도메인 로직, 결제/정산 | C6 가중 ×1.5, C4 가중 ×1.5 |
| `일반` | 위에 해당하지 않는 경우 | 기본 가중치 (모두 ×1.0) |

3. 모호하거나 결정이 필요한 부분이 있으면 `AskUserQuestion`으로 먼저 확인:
   - 기술적 선택지 (예: JWT vs 세션, Redis vs 인메모리)
   - 범위 확인 (어디까지 포함하는가)
   - 우선순위 (성능 vs 구현 속도 vs 유지보수성)
4. 관련 코드베이스 탐색 (Glob, Grep, Read)으로 현재 상태 파악

### 1단계: 팀 구성

```
TeamCreate({ team_name: "deep-plan-[작업요약]", description: "..." })
```

태스크 2개 생성:
```
TaskCreate({ subject: "구현 계획서 작성", description: "...", activeForm: "계획서 작성 중" })
TaskCreate({ subject: "계획서 비평", description: "...", activeForm: "계획서 비평 중" })
```

### 2단계: Planner 에이전트 스폰

Plan 서브에이전트를 생성하여 **촘촘한 구현 계획서**를 작성합니다:

```
Task({
  subagent_type: "Plan",
  name: "planner",
  team_name: "deep-plan-[작업요약]",
  prompt: "다음 요구사항에 대한 상세 구현 계획서를 작성하세요: [요구사항]

  === 계획서 필수 포함 항목 ===

  1. **요구사항 분석**
     - 명시적 요구사항 목록
     - 암묵적 요구사항 (추론된 것)
     - 범위 밖 항목 (명시적 제외)

  2. **영향도 분석**
     - 수정 대상 파일 목록 (경로 + 변경 유형: 생성/수정/삭제)
     - 기존 코드와의 의존성
     - 잠재적 사이드이펙트

  3. **단계별 구현 계획**
     - 각 단계는 독립 테스트 가능한 단위
     - 단계당 1~3개 파일만 수정
     - 각 단계의 완료 조건 (검증 방법 포함)
     - 단계 간 의존성 명시

  4. **기술적 결정**
     - 선택한 방식 + 고려한 대안 (최소 1개)
     - 각 대안의 트레이드오프
     - 선택 이유

  5. **위험 요소**
     - 실패 가능성과 대응 방안
     - 성능 영향
     - 보안 고려사항 (금지 패턴 12개 해당 여부)

  6. **테스트 전략**
     - 단계별 검증 방법
     - 엣지 케이스 목록
     - 회귀 테스트 필요 여부

  프로젝트 컨벤션과 기존 패턴을 반드시 따르세요."
})
```

### 3단계: Critic 에이전트 스폰 (가중치 비평)

Planner의 계획서가 완성되면, Plan 서브에이전트로 **가중치 기반 7가지 관점의 냉혹한 비평**을 수행합니다:

```
Task({
  subagent_type: "Plan",
  name: "critic",
  team_name: "deep-plan-[작업요약]",
  prompt: "다음 구현 계획서를 7가지 관점에서 냉혹하게 비평하세요.
  각 관점을 0~10점으로 채점하고, 구체적인 근거를 제시하세요.

  === 작업 유형 및 가중치 ===

  이 작업의 유형 태그: [0단계에서 분류한 태그]

  가중치 매트릭스:

  | 관점 | 기본 가중치 | 보안 | UI | 인프라 | 데이터 | 비즈니스 |
  |------|-----------|------|-----|--------|--------|---------|
  | C1. 실현 가능성 | 1.0 | 1.0 | 1.0 | 1.5 | 1.0 | 1.0 |
  | C2. 완전성 | 1.0 | 1.0 | 1.0 | 1.0 | 1.5 | 1.0 |
  | C3. 과잉 설계 방지 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 |
  | C4. 사용자 의도 부합 | 1.0 | 1.0 | 1.5 | 1.0 | 1.0 | 1.5 |
  | C5. 기존 패턴 준수 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 |
  | C6. 보안 | 1.0 | 2.0 | 1.0 | 1.0 | 1.0 | 1.5 |
  | C7. 단계 분해 품질 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 |

  현재 적용할 가중치 열: [해당 유형 열]

  === 비평 관점 ===

  C1. 실현 가능성 (0~10) × 가중치
     - 현재 코드베이스에서 실제로 구현 가능한가?
     - 의존성/환경 제약은 없는가?

  C2. 완전성 (0~10) × 가중치
     - 누락된 파일, 설정, 에러 처리가 없는가?
     - 모든 경로(정상/에러)가 다뤄졌는가?

  C3. 과잉 설계 방지 (0~10) × 가중치
     - YAGNI 원칙 위반이 없는가?
     - 불필요한 추상화나 사전 최적화가 있는가?

  C4. 사용자 의도 부합 (0~10) × 가중치
     - 원래 요청과 어긋나는 부분이 없는가?
     - 범위를 넘어서는 작업이 포함되지 않았는가?

  C5. 기존 패턴 준수 (0~10) × 가중치
     - 프로젝트의 기존 컨벤션을 따르는가?
     - JINHAK 표준 규칙에 위반되는 부분이 없는가?

  C6. 보안 (0~10) × 가중치
     - 금지 코드 패턴 12개에 해당하는 부분이 없는가?
     - 인증/인가, 데이터 보호 관련 누락이 없는가?

  C7. 단계 분해 품질 (0~10) × 가중치
     - 각 단계가 독립적으로 테스트 가능한가?
     - 단계 크기가 적절한가 (너무 크거나 작지 않은가)?

  === 출력 형식 ===

  각 관점별:
  - 원점수: N/10
  - 가중치: ×W
  - 가중 점수: N×W
  - 판정: 통과/경고/치명적
  - 근거: [구체적 설명]
  - 개선 제안: [있으면]

  가중 총점: NN.N / 가중 만점(NN.N)
  가중 비율: NN.N%
  치명적 문제: N건
  C6 보안 관문: N/10 (Hard Gate 대상 여부: Y/N)
  종합 판정: 수렴/재작업 필요

  [계획서 내용]"
})
```

### 4단계: 수렴 판정 (가중치 + Hard Gate)

비평 결과를 분석하여 수렴 여부를 판정합니다:

**수렴 기준 (가중치 기반):**
- **가중 비율** `가중총점 / 가중만점 ≥ 80%` AND 치명적 문제 **0건** → **수렴 (통과)**
- 미달 시 → Planner에게 비평 내용 전달 후 **재작성 지시**

**C6 Hard Gate (보안 관문):**

작업이 Human-in-the-Loop 필수 영역(인증/인가, 결제/정산, 개인정보, 암호화, 인프라, 데이터 마이그레이션)에 해당하는 경우:
- C6 보안 점수 **8/10 이상** 필수 (가중 비율 80% 충족과 별개)
- C6 < 8 이면 전체 가중 비율과 무관하게 **재작업 필요**

**보안 관문 상태 테이블:**

| 조건 | C6 Hard Gate | 판정 |
|------|-------------|------|
| 보안/비즈니스 유형 + C6 ≥ 8 | 통과 | 가중 비율로 최종 판정 |
| 보안/비즈니스 유형 + C6 < 8 | **실패** | 가중 비율 무관, 재작업 필요 |
| 일반/UI/인프라/데이터 유형 | 해당 없음 | 가중 비율로 최종 판정 |

**반복 규칙:**
- 최대 **3라운드** (초기 계획 + 수정 2회)
- 라운드 간 가중 비율 개선이 **+5%p 미만**이면 → 정체로 판단, 사용자 위임
- 3라운드 초과 시 → 전체 계획 + 비평 이력을 사용자에게 제시하고 판단 위임

**NightBuilder 환경 분기:**

NightBuilder(무인 자동 개발) 환경에서 3라운드 내 미수렴 시:
1. 현재까지의 계획서 + 비평 이력을 `.ai/PENDING_PLANS.md`에 저장:
   ```markdown
   ## [보류] YYYY-MM-DD HH:mm - [작업요약]
   - 상태: 미수렴 (라운드 N, 가중 비율 NN.N%)
   - C6 Hard Gate: 통과/실패/해당없음
   - 저장된 계획서: `.ai/plans/YYYY-MM-DD_HHmm_[작업요약].md`
   - 사유: [정체/라운드 초과/C6 Hard Gate 실패]
   ```
2. 다음 태스크로 진행 (교착 방지)
3. 다음 세션(사람 참여) 시 `session-briefing.cjs`가 보류 건을 감지하여 안내

**재작성 지시 시:**
```
SendMessage({
  type: "message",
  recipient: "planner",
  content: "비평 결과를 반영하여 계획서를 수정하세요:\n[비평 내용 전달]\n\n특히 다음을 개선해주세요:\n- [치명적/경고 항목 요약]",
  summary: "비평 반영 계획서 수정 요청"
})
```

### 5단계: 최종 계획서 저장

수렴된 최종 계획을 `.ai/plans/` 폴더에 자동 저장합니다:

**파일명 형식:** `YYYY-MM-DD_HHmm_[작업요약].md`
- 예: `2026-02-28_1430_사용자-인증-시스템.md`
- 작업요약은 kebab-case, 한글 허용, 20자 이내

**저장 내용:**
```markdown
# Deep Plan: [작업 제목]

> 생성일: YYYY-MM-DD HH:mm
> 작업 유형: [태그]
> 라운드: N회 (초기 + 수정 N-1회)
> 가중 점수: NN.N / NN.N (NN.N%)
> C6 Hard Gate: 통과 / 실패 / 해당없음
> 상태: 수렴 / 사용자 위임

## 비평 점수

| 관점 | 원점수 | 가중치 | 가중 점수 | 판정 |
|------|--------|--------|----------|------|
| C1. 실현 가능성 | N/10 | ×W | N.N | 통과 |
| C2. 완전성 | N/10 | ×W | N.N | 통과 |
| C3. 과잉 설계 방지 | N/10 | ×W | N.N | 통과 |
| C4. 사용자 의도 부합 | N/10 | ×W | N.N | 통과 |
| C5. 기존 패턴 준수 | N/10 | ×W | N.N | 통과 |
| C6. 보안 | N/10 | ×W | N.N | 통과 |
| C7. 단계 분해 품질 | N/10 | ×W | N.N | 통과 |

### 보안 관문 상태

| 항목 | 값 |
|------|-----|
| 작업 유형 | [태그] |
| C6 Hard Gate 대상 | Y/N |
| C6 원점수 | N/10 |
| 관문 판정 | 통과/실패/해당없음 |

## 요구사항 분석
[Planner 산출물의 요구사항 분석 섹션]

## 영향도 분석
[수정 대상 파일 목록, 의존성, 사이드이펙트]

## 단계별 구현 계획
[전체 단계별 계획]

## 기술적 결정
[선택한 방식, 대안, 트레이드오프]

## 위험 요소
[실패 가능성, 대응 방안]

## 테스트 전략
[검증 방법, 엣지 케이스]

## 비평 이력
### 라운드 1
- 가중 점수: NN.N / NN.N (NN.N%)
- 주요 지적: [요약]

### 라운드 2 (있으면)
- 가중 점수: NN.N / NN.N (NN.N%)
- 개선된 점: [요약]
```

**저장 절차:**
1. `.ai/plans/` 폴더가 없으면 생성
2. 위 형식으로 마크다운 파일 작성
3. 사용자에게 저장 경로 안내

### 6단계: 사용자 제시 및 다음 단계 선택

최종 계획 요약과 저장 경로를 사용자에게 제시합니다:

```markdown
## /deep-plan 결과

### 작업 유형: [태그]

### 비평 점수 (가중)
| 관점 | 원점수 | 가중 점수 | 판정 |
|------|--------|----------|------|
| C1~C7 ... |

### 보안 관문
| 항목 | 값 |
|------|-----|
| C6 Hard Gate 대상 | Y/N |
| C6 원점수 | N/10 |
| 관문 판정 | 통과/해당없음 |

### 구현 계획 요약
[단계별 요약]

### 계획서 저장됨
📄 `.ai/plans/YYYY-MM-DD_HHmm_[작업요약].md`
```

> **보안 관문 경고**: C6 Hard Gate 대상 작업(보안/비즈니스 유형)이면 "⚠️ 이 계획은 Human-in-the-Loop 필수 영역(인증/결제/개인정보 등)을 포함합니다. 구현 후 **시니어 개발자 리뷰가 필수**입니다." 경고를 출력합니다.

`AskUserQuestion`으로 다음 행동을 확인:
1. **바로 구현 시작** - 계획에 따라 단계별 구현 진행
2. **`/orchestrate`로 병렬 구현** - 독립 단계를 Agent Teams로 분배
3. **계획 수정 요청** - 특정 부분 재검토
4. **여기서 종료** - 계획서는 이미 저장됨

### 6.5단계: 계획 품질 기록 (사후 검증용)

수렴된 계획의 실행 결과를 추적하기 위해 `.ai/DECISIONS.md`에 기록합니다:

```markdown
## DP-NNN: [작업 제목] (deep-plan)

### 상태
승인됨 (YYYY-MM)

### deep-plan 실행 결과
- 작업 유형: [태그]
- 라운드: N회
- 가중 점수: NN.N / NN.N (NN.N%)
- C6 Hard Gate: 통과/실패/해당없음
- 계획서: `.ai/plans/YYYY-MM-DD_HHmm_[작업요약].md`

### 구현 후 실제 이슈
(구현 완료 후 /session-end 시 기록)
- [ ] 계획대로 구현되었는가?
- [ ] 예상치 못한 이슈가 있었는가?
- [ ] 비평에서 놓친 점이 있었는가?
```

> 이 기록은 `/session-end`의 4단계에서 사후 검증되어 deep-plan의 품질 개선에 활용됩니다.

### 7단계: 팀 종료

```
SendMessage({ type: "shutdown_request", recipient: "planner", content: "계획 수립 완료" })
SendMessage({ type: "shutdown_request", recipient: "critic", content: "비평 완료" })
// 팀원 approve 후:
TeamDelete()
```

---

## /orchestrate와의 관계

`/deep-plan`과 `/orchestrate`는 **별개의 독립 스킬**이지만, 파이프라인으로 연결할 수 있습니다:

```
/deep-plan → 수렴된 계획 → /orchestrate로 병렬 구현 (선택)
```

- `/deep-plan`: **무엇을, 어떤 순서로** 할지 결정 (계획 품질 검증)
- `/orchestrate`: **어떻게 분배하여** 실행할지 결정 (병렬 실행)

---

## 가중치 매트릭스 요약

| 관점 | 기본 | 보안 | UI | 인프라 | 데이터 | 비즈니스 |
|------|------|------|-----|--------|--------|---------|
| C1. 실현 가능성 | 1.0 | 1.0 | 1.0 | **1.5** | 1.0 | 1.0 |
| C2. 완전성 | 1.0 | 1.0 | 1.0 | 1.0 | **1.5** | 1.0 |
| C3. 과잉 설계 방지 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 |
| C4. 사용자 의도 부합 | 1.0 | 1.0 | **1.5** | 1.0 | 1.0 | **1.5** |
| C5. 기존 패턴 준수 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 |
| C6. 보안 | 1.0 | **2.0** | 1.0 | 1.0 | 1.0 | **1.5** |
| C7. 단계 분해 품질 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 | 1.0 |
| **가중 만점** | **70** | **80** | **75** | **75** | **75** | **80** |

> `일반` 유형: 가중 만점 70 = 기존과 동일. 유형별 가중치로 만점이 달라지므로 비율(%)로 수렴 판정.

---

## 비평 관점 상세 (수동 점검용)

`/deep-plan` 없이 수동으로 계획을 점검할 때도 C1~C7 체크리스트를 활용할 수 있습니다:

| 코드 | 관점 | 8점 미만 시 확인 |
|------|------|----------------|
| C1 | 실현 가능성 | 구현 불가능한 부분이 없는지 확인 |
| C2 | 완전성 | 누락된 파일/설정/에러 처리 확인 |
| C3 | 과잉 설계 방지 | 불필요한 추상화/YAGNI 위반 확인 |
| C4 | 사용자 의도 부합 | 원래 요청과 어긋나는 부분 확인 |
| C5 | 기존 패턴 준수 | 프로젝트 컨벤션 위반 확인 |
| C6 | 보안 | 금지 패턴 12개 해당 여부 확인 |
| C7 | 단계 분해 품질 | 단계 독립성/크기 적절성 확인 |

## 주의사항

- Planner와 Critic은 **읽기 전용** 에이전트 (Plan 타입) — 코드를 직접 수정하지 않음
- Plan 타입이 사용 불가능한 경우 Explore → general-purpose(파일 수정 금지 지시) 순으로 폴백
- 비평은 냉혹하게 하되, **건설적인 대안**을 반드시 제시
- 3라운드 내 수렴하지 않으면 무한 반복하지 않고 사용자에게 위임 (NightBuilder는 PENDING_PLANS.md 저장)
- C6 Hard Gate는 보안/비즈니스 유형에서만 적용 — 일반 작업에 과도한 보안 검증을 강제하지 않음
