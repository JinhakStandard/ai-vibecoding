---
name: deep-plan
description: Planner-Critic 듀얼 에이전트로 심층 계획을 수립하고 비평 피드백 루프를 통해 품질을 검증
---

복잡한 기능 구현 전에 **Planner(계획 수립)**와 **Critic(냉혹한 비평)** 2개 에이전트를 활용하여 촘촘한 구현 계획을 수립하고, 피드백 루프를 통해 계획 품질을 검증합니다.

## 인자
$ARGUMENTS - 구현할 기능/작업에 대한 설명 (필수)

## 사용법
```
/deep-plan 사용자 인증 시스템 구현 (JWT + 세션)
/deep-plan 대시보드 성능 최적화
/deep-plan DB 스키마 마이그레이션 (PostgreSQL → MSSQL)
```

## 언제 사용하는가

| 적합 | 부적합 |
|------|--------|
| 5개+ 파일 수정, 아키텍처 결정 포함 | 단순 버그 수정 (1~2줄) |
| 여러 구현 방법이 가능한 경우 | 명확한 지시가 있는 단일 파일 수정 |
| 신규 모듈/서비스 설계 | 순수 탐색/리서치 작업 |
| 보안/성능 민감한 대규모 변경 | 이미 계획이 확정된 작업 |

> 간단한 작업은 Plan 모드(`EnterPlanMode`)로 충분합니다. `/deep-plan`은 **계획 자체의 품질 검증**이 필요할 때 사용합니다.

---

## 실행 절차

### 0단계: 사전 분석 및 요구사항 정제

1. 사용자의 요청(`$ARGUMENTS`)을 분석하여 **명시적 요구사항**과 **암묵적 요구사항** 분리
2. 모호하거나 결정이 필요한 부분이 있으면 `AskUserQuestion`으로 먼저 확인:
   - 기술적 선택지 (예: JWT vs 세션, Redis vs 인메모리)
   - 범위 확인 (어디까지 포함하는가)
   - 우선순위 (성능 vs 구현 속도 vs 유지보수성)
3. 관련 코드베이스 탐색 (Glob, Grep, Read)으로 현재 상태 파악

### 1단계: 팀 구성

```
TeamCreate({ team_name: "deep-plan-[작업요약]", description: "..." })
```

태스크 2개 생성:
```
TaskCreate({ subject: "구현 계획서 작성", description: "...", activeForm: "계획서 작성 중" })
TaskCreate({ subject: "계획서 비평", description: "...", activeForm: "계획서 비평 중" })
```

### 2단계: Planner 에이전트 스폰

Plan 서브에이전트를 생성하여 **촘촘한 구현 계획서**를 작성합니다:

```
Task({
  subagent_type: "Plan",
  name: "planner",
  team_name: "deep-plan-[작업요약]",
  prompt: "다음 요구사항에 대한 상세 구현 계획서를 작성하세요: [요구사항]

  === 계획서 필수 포함 항목 ===

  1. **요구사항 분석**
     - 명시적 요구사항 목록
     - 암묵적 요구사항 (추론된 것)
     - 범위 밖 항목 (명시적 제외)

  2. **영향도 분석**
     - 수정 대상 파일 목록 (경로 + 변경 유형: 생성/수정/삭제)
     - 기존 코드와의 의존성
     - 잠재적 사이드이펙트

  3. **단계별 구현 계획**
     - 각 단계는 독립 테스트 가능한 단위
     - 단계당 1~3개 파일만 수정
     - 각 단계의 완료 조건 (검증 방법 포함)
     - 단계 간 의존성 명시

  4. **기술적 결정**
     - 선택한 방식 + 고려한 대안 (최소 1개)
     - 각 대안의 트레이드오프
     - 선택 이유

  5. **위험 요소**
     - 실패 가능성과 대응 방안
     - 성능 영향
     - 보안 고려사항 (금지 패턴 12개 해당 여부)

  6. **테스트 전략**
     - 단계별 검증 방법
     - 엣지 케이스 목록
     - 회귀 테스트 필요 여부

  프로젝트 컨벤션과 기존 패턴을 반드시 따르세요."
})
```

### 3단계: Critic 에이전트 스폰

Planner의 계획서가 완성되면, Plan 서브에이전트로 **7가지 관점의 냉혹한 비평**을 수행합니다:

```
Task({
  subagent_type: "Plan",
  name: "critic",
  team_name: "deep-plan-[작업요약]",
  prompt: "다음 구현 계획서를 7가지 관점에서 냉혹하게 비평하세요.
  각 관점을 0~10점으로 채점하고, 구체적인 근거를 제시하세요.

  === 비평 관점 ===

  C1. 실현 가능성 (0~10)
     - 현재 코드베이스에서 실제로 구현 가능한가?
     - 의존성/환경 제약은 없는가?

  C2. 완전성 (0~10)
     - 누락된 파일, 설정, 에러 처리가 없는가?
     - 모든 경로(정상/에러)가 다뤄졌는가?

  C3. 과잉 설계 방지 (0~10)
     - YAGNI 원칙 위반이 없는가?
     - 불필요한 추상화나 사전 최적화가 있는가?

  C4. 사용자 의도 부합 (0~10)
     - 원래 요청과 어긋나는 부분이 없는가?
     - 범위를 넘어서는 작업이 포함되지 않았는가?

  C5. 기존 패턴 준수 (0~10)
     - 프로젝트의 기존 컨벤션을 따르는가?
     - JINHAK 표준 규칙에 위반되는 부분이 없는가?

  C6. 보안 (0~10)
     - 금지 코드 패턴 12개에 해당하는 부분이 없는가?
     - 인증/인가, 데이터 보호 관련 누락이 없는가?

  C7. 단계 분해 품질 (0~10)
     - 각 단계가 독립적으로 테스트 가능한가?
     - 단계 크기가 적절한가 (너무 크거나 작지 않은가)?

  === 출력 형식 ===

  각 관점별:
  - 점수: N/10
  - 판정: 통과/경고/치명적
  - 근거: [구체적 설명]
  - 개선 제안: [있으면]

  총점: NN/70
  치명적 문제: N건
  종합 판정: 수렴/재작업 필요

  [계획서 내용]"
})
```

### 4단계: 수렴 판정

비평 결과를 분석하여 수렴 여부를 판정합니다:

**수렴 기준:**
- 총점 **56/70 (80%) 이상** AND 치명적 문제 **0건** → **수렴 (통과)**
- 미달 시 → Planner에게 비평 내용 전달 후 **재작성 지시**

**반복 규칙:**
- 최대 **3라운드** (초기 계획 + 수정 2회)
- 라운드 간 점수 개선이 **+5점 미만**이면 → 정체로 판단, 사용자 위임
- 3라운드 초과 시 → 전체 계획 + 비평 이력을 사용자에게 제시하고 판단 위임

**재작성 지시 시:**
```
SendMessage({
  type: "message",
  recipient: "planner",
  content: "비평 결과를 반영하여 계획서를 수정하세요:\n[비평 내용 전달]\n\n특히 다음을 개선해주세요:\n- [치명적/경고 항목 요약]",
  summary: "비평 반영 계획서 수정 요청"
})
```

### 5단계: 사용자 제시 및 다음 단계 선택

수렴된 최종 계획을 사용자에게 제시합니다:

```markdown
## /deep-plan 결과

### 비평 점수
| 관점 | 점수 | 판정 |
|------|------|------|
| C1. 실현 가능성 | N/10 | 통과 |
| C2. 완전성 | N/10 | 통과 |
| C3. 과잉 설계 방지 | N/10 | 통과 |
| C4. 사용자 의도 부합 | N/10 | 통과 |
| C5. 기존 패턴 준수 | N/10 | 통과 |
| C6. 보안 | N/10 | 통과 |
| C7. 단계 분해 품질 | N/10 | 통과 |
| **총점** | **NN/70** | **수렴** |

### 구현 계획 요약
[단계별 요약]

### 다음 단계 선택
```

`AskUserQuestion`으로 다음 행동을 확인:
1. **바로 구현 시작** - 계획에 따라 단계별 구현 진행
2. **`/orchestrate`로 병렬 구현** - 독립 단계를 Agent Teams로 분배
3. **계획 수정 요청** - 특정 부분 재검토
4. **계획만 저장** - `.ai/DECISIONS.md`에 기록 후 종료

### 6단계: 팀 종료

```
SendMessage({ type: "shutdown_request", recipient: "planner", content: "계획 수립 완료" })
SendMessage({ type: "shutdown_request", recipient: "critic", content: "비평 완료" })
// 팀원 approve 후:
TeamDelete()
```

---

## /orchestrate와의 관계

`/deep-plan`과 `/orchestrate`는 **별개의 독립 스킬**이지만, 파이프라인으로 연결할 수 있습니다:

```
/deep-plan → 수렴된 계획 → /orchestrate로 병렬 구현 (선택)
```

- `/deep-plan`: **무엇을, 어떤 순서로** 할지 결정 (계획 품질 검증)
- `/orchestrate`: **어떻게 분배하여** 실행할지 결정 (병렬 실행)

---

## 비평 관점 상세 (수동 점검용)

`/deep-plan` 없이 수동으로 계획을 점검할 때도 C1~C7 체크리스트를 활용할 수 있습니다:

| 코드 | 관점 | 8점 미만 시 확인 |
|------|------|----------------|
| C1 | 실현 가능성 | 구현 불가능한 부분이 없는지 확인 |
| C2 | 완전성 | 누락된 파일/설정/에러 처리 확인 |
| C3 | 과잉 설계 방지 | 불필요한 추상화/YAGNI 위반 확인 |
| C4 | 사용자 의도 부합 | 원래 요청과 어긋나는 부분 확인 |
| C5 | 기존 패턴 준수 | 프로젝트 컨벤션 위반 확인 |
| C6 | 보안 | 금지 패턴 12개 해당 여부 확인 |
| C7 | 단계 분해 품질 | 단계 독립성/크기 적절성 확인 |

## 주의사항

- Planner와 Critic은 **읽기 전용** 에이전트 (Plan 타입) — 코드를 직접 수정하지 않음
- Plan 타입이 사용 불가능한 경우 Explore → general-purpose(파일 수정 금지 지시) 순으로 폴백
- 비평은 냉혹하게 하되, **건설적인 대안**을 반드시 제시
- 3라운드 내 수렴하지 않으면 무한 반복하지 않고 사용자에게 위임
