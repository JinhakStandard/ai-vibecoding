# AI 보안 가이드레일: 7-Layer Defense 아키텍처

<!-- jinhak_standard_version: 2.0 -->
<!-- document_type: security-master -->
<!-- last_updated: 2026-02-20 -->

---

## 1. 개요 및 목적

이 문서는 JINHAK의 모든 AI 개발(Claude Code / Claude.ai 협업) 환경에서 적용해야 하는 **7-Layer Defense 보안 가이드레일**을 정의합니다.

**목적:**
- OWASP LLM Top 10 (2025)에 대응하는 체계적 방어 체계 수립
- AI 코드 생성 과정에서 발생할 수 있는 보안 위협의 사전 차단
- 진학어플라이 수험생 개인정보 보호 및 ISMS-P 인증 요건 충족
- AI 자동화(NightBuilder 등) 환경에서의 보안 통제

**적용 범위:**
- Claude Code를 활용하는 모든 JINHAK 프로젝트
- AI가 생성하는 모든 코드, 설정 파일, 인프라 스크립트
- AI에 전달되는 모든 컨텍스트(프롬프트, 파일, 데이터)
- NightBuilder 등 24/7 자동 개발 환경

---

## 2. 7-Layer Defense 아키텍처 개요

```
┌─────────────────────────────────────────────────────────┐
│                    AI 개발 워크플로우                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌───────────────────────────────────────────────────┐  │
│  │ Layer 7: 거버넌스 (Governance)                     │  │
│  │  역할/책임, 정기 감사, 인시던트 대응                   │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ Layer 6: 데이터 보안 (Data Security)               │  │
│  │  데이터 분류, 마스킹, 로그 보안                       │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ Layer 5: 런타임 보안 (Runtime Security)             │  │
│  │  실행 환경 격리, NightBuilder 보안                    │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ Layer 4: 출력 검증 (Output Verification)            │  │
│  │  Hooks, AI 코드 식별, Human-in-the-Loop             │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ Layer 3: 의존성 보안 (Dependency Security)          │  │
│  │  패키지 검증, Lock 파일 보호, 공급망 보안               │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ Layer 2: 코드 생성 보안 (Code Generation Security)  │  │
│  │  보안 코딩 표준, OWASP 매핑, 금지 패턴                │  │
│  ├───────────────────────────────────────────────────┤  │
│  │ Layer 1: 입력 보안 (Input Security)                 │  │
│  │  Prompt Injection 방어, 컨텍스트 보안                 │  │
│  └───────────────────────────────────────────────────┘  │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

각 레이어는 독립적으로 동작하며, 하위 레이어에서 놓친 위협을 상위 레이어에서 포착하는 **심층 방어(Defense in Depth)** 원칙을 따릅니다.

---

## 3. Layer 1: 입력 보안 (Input Security)

AI에 전달되는 모든 입력(프롬프트, 파일, 데이터)을 통제합니다.

### 3.1 Prompt Injection 방어

| 위협 | 방어 수단 | 구현 위치 |
|------|----------|----------|
| Direct Prompt Injection | 시스템 프롬프트와 사용자 입력 분리, 명확한 역할 구분 | CLAUDE.md 규칙 |
| Indirect Prompt Injection | 외부 데이터(파일, URL) 내 악성 지시 탐지 | PreToolUse Hook |
| Context Poisoning | 신뢰할 수 없는 소스의 컨텍스트 주입 차단 | settings.json deny 규칙 |

**핵심 규칙:**
- AI에 전달되는 외부 데이터는 반드시 **신뢰할 수 있는 소스**에서만 가져올 것
- 사용자 입력을 직접 시스템 프롬프트에 삽입하지 말 것
- `.claude/` 디렉토리 내 설정 파일의 무결성을 정기적으로 검증할 것

### 3.2 컨텍스트 보안

AI 세션에 전달되는 컨텍스트에서 민감 정보를 사전 제거합니다.

**전달 금지 데이터:**
- 수험생 개인정보 (주민번호, 성적, 지원 이력)
- 데이터베이스 접속 정보, API Key, 비밀번호
- 프로덕션 환경의 실제 데이터
- 내부 보안 감사 결과 상세 내역

**전달 시 마스킹 필수 데이터:**
- 테스트용 사용자 정보 (가명화 처리)
- 시스템 설정 정보 (민감 값 마스킹)
- 로그 데이터 (개인 식별 정보 제거)

### 3.3 민감 파일 제외

다음 파일은 AI 컨텍스트에 절대 포함하지 않습니다.

```
# AI 컨텍스트 제외 파일 목록
.env, .env.*                    # 환경 변수
*.pem, *.key, *.p12             # 인증서/키
credentials.json                # 인증 정보
**/secrets/**                   # 시크릿 디렉토리
**/config/production.*          # 프로덕션 설정
**/backup/**                    # 백업 데이터
```

---

## 4. Layer 2: 코드 생성 보안 (Code Generation Security)

AI가 생성하는 코드의 보안 품질을 통제합니다.

### 4.1 보안 코딩 표준

| 영역 | 규칙 | 검증 방법 |
|------|------|----------|
| 입력 검증 | 모든 외부 입력에 검증/새니타이징 적용 | ESLint 규칙 + 코드 리뷰 |
| 출력 인코딩 | HTML/SQL/OS 명령에 사용되는 데이터 인코딩 | SAST 스캔 |
| 인증/인가 | 검증된 라이브러리만 사용 (passport, next-auth 등) | 의존성 검증 |
| 암호화 | 최소 AES-256, SHA-256 이상 사용 | 코드 리뷰 |
| 에러 처리 | 스택 트레이스, 내부 정보 외부 노출 금지 | SAST 스캔 |
| 세션 관리 | 안전한 쿠키 설정 (httpOnly, secure, sameSite) | 설정 검증 |

### 4.2 OWASP 매핑

AI가 생성하는 코드는 OWASP Web Top 10과 OWASP LLM Top 10 양쪽 모두에 대응해야 합니다. 상세 교차 매핑은 [OWASP_LLM_CHECKLIST.md](./OWASP_LLM_CHECKLIST.md)를 참조하세요.

### 4.3 금지 패턴

AI가 절대 생성해서는 안 되는 12개 위험 코드 패턴이 정의되어 있습니다. 상세 목록과 안전한 대안은 [FORBIDDEN_PATTERNS.md](./FORBIDDEN_PATTERNS.md)를 참조하세요.

**Claude Code PreToolUse Hook**에서 코드 생성 시 금지 패턴 포함 여부를 자동 검사하며, 탐지 시 BLOCK 또는 WARN 조치를 수행합니다.

---

## 5. Layer 3: 의존성 보안 (Dependency Security)

AI가 추천하거나 추가하는 모든 외부 패키지의 보안을 검증합니다.

### 5.1 패키지 검증 기준

| 검증 항목 | 기준 | 비고 |
|-----------|------|------|
| 주간 다운로드 수 | 최소 10,000회 이상 | npm 기준 |
| 마지막 업데이트 | 1년 이내 | 유지보수 활성도 |
| 알려진 취약점 | CVE 0건 (Critical/High) | npm audit 기준 |
| 라이선스 | MIT, Apache 2.0, ISC 허용 | GPL 계열 사전 승인 필요 |
| 의존성 깊이 | transitive 의존성 100개 이하 권장 | 공급망 공격 위험 감소 |

### 5.2 Lock 파일 보호

```
# Lock 파일 변경 시 반드시 확인
package-lock.json
pnpm-lock.yaml
yarn.lock
```

**규칙:**
- AI가 lock 파일을 직접 수정하는 것을 금지
- `npm install` / `pnpm install` 명령을 통해서만 lock 파일 업데이트
- lock 파일 변경이 포함된 PR은 의존성 diff를 반드시 리뷰

### 5.3 공급망 공격 대응

- 타이포스쿼팅(typosquatting) 의심 패키지 감지: 유사한 이름의 패키지 설치 시 경고
- AI가 존재하지 않는 패키지(hallucinated package)를 추천할 수 있으므로, 설치 전 npm 레지스트리 존재 확인 필수
- `npm audit` 또는 `pnpm audit`을 CI 파이프라인에 필수 포함

---

## 6. Layer 4: 출력 검증 (Output Verification)

AI가 생성한 코드가 실제로 적용되기 전 검증합니다.

### 6.1 Claude Code Hooks 검증

| Hook | 검증 내용 | 조치 |
|------|----------|------|
| PreToolUse (Edit/Write) | 금지 패턴 탐지, 민감 파일 수정 감지 | BLOCK 또는 WARN |
| PostToolUse (Edit/Write) | ESLint 자동 수정, 포맷팅 검증 | 자동 수정 |
| Stop | 세션 요약, 보안 이벤트 기록 | LOG |

### 6.2 AI 코드 식별

AI가 생성한 모든 코드는 추적 가능해야 합니다.

**식별 방법:**
- 커밋 메시지에 `Co-Authored-By: Claude <noreply@anthropic.com>` 필수 포함
- PR 설명에 AI 생성 코드 범위 명시
- 중요 함수/모듈에 AI 생성 여부 주석 (선택)

### 6.3 Human-in-the-Loop 필수 영역

다음 영역은 AI가 코드를 생성하더라도 **반드시 사람이 최종 검토**해야 합니다.

| 영역 | 이유 | 최소 리뷰어 수 |
|------|------|---------------|
| 인증/인가 로직 | 보안 핵심 영역 | 2명 |
| 결제 처리 로직 | 금전적 손해 가능 | 2명 |
| 데이터베이스 마이그레이션 | 데이터 손실 위험 | 2명 |
| 개인정보 처리 로직 | 법적 규제 대상 | 2명 + 보안 담당자 |
| 인프라/배포 설정 | 서비스 장애 위험 | 1명 + DevOps |
| 암호화/해시 로직 | 보안 핵심 영역 | 2명 |
| 외부 API 연동 | 데이터 유출 위험 | 1명 |

---

## 7. Layer 5: 런타임 보안 (Runtime Security)

AI가 코드를 실행하는 환경의 보안을 통제합니다.

### 7.1 실행 환경 격리

| 환경 | 격리 수준 | AI 접근 범위 |
|------|----------|-------------|
| 로컬 개발 | 프로젝트 디렉토리 내 | 프로젝트 파일 + 허용된 도구 |
| CI/CD | 컨테이너 격리 | 빌드 아티팩트만 |
| NightBuilder | 강화된 격리 | 지정된 브랜치만 |
| 프로덕션 | AI 직접 접근 금지 | 접근 불가 |

**핵심 규칙:**
- AI는 프로덕션 환경에 **절대 직접 접근할 수 없음**
- 로컬 환경에서도 `settings.json`의 `deny` 규칙으로 위험 명령 차단
- NightBuilder 환경은 추가 보안 규칙 적용 (상세: [NIGHTBUILDER_SECURITY.md](./NIGHTBUILDER_SECURITY.md))

### 7.2 네트워크 접근 제한

- AI 세션에서 외부 네트워크 접근은 허용된 도메인만 가능
- 내부 네트워크(DB, 관리 시스템)에 대한 직접 접근 금지
- WebFetch 사용 시 신뢰할 수 있는 도메인만 허용

---

## 8. Layer 6: 데이터 보안 (Data Security)

AI 개발 과정에서 다루는 데이터의 보안을 통제합니다.

### 8.1 데이터 분류

모든 데이터는 4단계로 분류되며, AI 전달 가능 여부가 결정됩니다. 상세 분류 기준은 [DATA_CLASSIFICATION.md](./DATA_CLASSIFICATION.md)를 참조하세요.

| 등급 | AI 전달 | 조건 |
|------|---------|------|
| 극비 (Strictly Confidential) | 절대 금지 | - |
| 대외비 (Confidential) | 금지 | - |
| 내부용 (Internal) | 조건부 허용 | 마스킹/가명화 후 |
| 공개 (Public) | 허용 | - |

### 8.2 로그 보안

**로깅 필수 항목:**
- AI 세션 시작/종료 시각
- AI가 접근한 파일 목록
- 실행된 명령어 (민감 인자 마스킹)
- 보안 스캔 결과 (통과/실패)

**로깅 금지 항목:**
- 프롬프트 전문 (요약만 가능)
- 소스 코드 전체
- 환경 변수 값
- 인증 토큰, API Key

**로그 보존 기간:**
- AI 작업 로그: 90일
- 보안 이벤트 로그: 1년
- ISMS 감사 로그: 관련 법령에 따름

---

## 9. Layer 7: 거버넌스 (Governance)

AI 보안의 조직적 관리 체계를 정의합니다.

### 9.1 역할과 책임

| 역할 | 책임 | 권한 |
|------|------|------|
| 개발자 | AI 생성 코드 1차 검토, 보안 규칙 준수 | AI 세션 운영, 코드 커밋 |
| 팀 리드 | PR 보안 리뷰, 팀 보안 수준 관리 | PR 승인, 보안 이슈 에스컬레이션 |
| 보안 담당자 | 보안 정책 수립, 감사, 인시던트 대응 | 보안 규칙 변경, 인시던트 조사 |
| CTO | 보안 전략 결정, 최종 승인 | 정책 최종 승인, P1 인시던트 의사결정 |

### 9.2 정기 활동

| 활동 | 주기 | 담당 | 산출물 |
|------|------|------|--------|
| AI 보안 규칙 리뷰 | 월 1회 | 보안 담당자 | 규칙 업데이트 PR |
| 금지 패턴 업데이트 | 분기 1회 | 보안 담당자 + 팀 리드 | FORBIDDEN_PATTERNS.md 갱신 |
| OWASP 체크리스트 점검 | 분기 1회 | 전체 팀 | 체크리스트 완료 보고서 |
| 보안 교육 | 반기 1회 | 보안 담당자 | 교육 이수 기록 |
| 모의 인시던트 훈련 | 연 1회 | 전체 팀 | 훈련 결과 보고서 |

### 9.3 인시던트 대응

AI 보안 인시던트 발생 시 대응 절차는 [INCIDENT_RESPONSE.md](./INCIDENT_RESPONSE.md)를 참조하세요.

**핵심 원칙:**
- 인시던트 탐지 즉시 AI 세션 종료
- 영향 범위 파악 후 격리 조치
- 원인 분석 및 재발 방지 대책 수립
- 심각도에 따른 SLA 준수

---

## 10. 기존 3중 방어 구조와의 관계

CLAUDE.md v1.x에서 정의한 3중 방어 구조는 7-Layer Defense에 다음과 같이 매핑됩니다.

| 기존 3중 방어 | 역할 | 7-Layer 매핑 |
|--------------|------|-------------|
| CLAUDE.md 규칙 (자연어 감지) | 프롬프트 해석 시 안티패턴 감지, 경고 + 대안 제시 | Layer 1 (입력 보안) + Layer 2 (코드 생성 보안) |
| settings.json deny 규칙 (하드 블로킹) | 위험 명령어 물리적 차단 | Layer 4 (출력 검증) + Layer 5 (런타임 보안) |
| hooks 보조 경고 (소프트 알림) | PreToolUse hook으로 파일 수정 전 보안 경고 | Layer 4 (출력 검증) |

**확장 내용:**
- 기존 3중 방어는 그대로 유지하면서, 7-Layer가 이를 포괄합니다
- Layer 3 (의존성 보안), Layer 6 (데이터 보안), Layer 7 (거버넌스)는 v2.0에서 새로 추가된 영역입니다
- 기존 프로젝트에서 3중 방어만 적용한 경우에도 기본적인 보안은 보장되며, 7-Layer 전체 적용은 점진적으로 진행합니다

---

## 11. 보안 등급별 행동 규칙

AI(Claude Code)가 보안 위협을 탐지했을 때의 행동 규칙을 3단계로 정의합니다.

### BLOCK (즉시 중단)

실행을 즉시 중단하고 사용자에게 경고합니다. 우회 불가.

| 대상 | 예시 |
|------|------|
| 금지 패턴 생성 | `eval()`, SQL Injection 코드 등 |
| 민감 데이터 노출 | 수험생 개인정보, 비밀키 포함 코드 |
| 위험 명령 실행 | `push --force`, `reset --hard`, `rm -rf` |
| 프로덕션 직접 조작 | 프로덕션 DB 쿼리, 배포 명령 |

### WARN (경고 + 확인)

경고 메시지를 표시하고 사용자의 명시적 확인을 요청합니다.

| 대상 | 예시 |
|------|------|
| 준위험 패턴 | `cors()` 설정 변경, 권한 로직 수정 |
| 새 패키지 추가 | 검증되지 않은 패키지 설치 |
| 설정 파일 변경 | `settings.json`, `tsconfig.json` 등 |
| lock 파일 변경 | `package-lock.json` 변경 포함 커밋 |

### LOG (기록만)

별도 중단 없이 로그에 기록합니다.

| 대상 | 예시 |
|------|------|
| 일반 코드 생성 | 보안 이슈 없는 기능 구현 |
| 파일 읽기 | 비민감 파일 조회 |
| 검색/분석 | 코드베이스 검색, 구조 분석 |
| 테스트 실행 | 단위/통합 테스트 실행 |

---

## 12. 관련 문서 참조

| 문서 | 설명 |
|------|------|
| [OWASP_LLM_CHECKLIST.md](./OWASP_LLM_CHECKLIST.md) | OWASP LLM Top 10 2025 + Web Top 10 교차 체크리스트 |
| [FORBIDDEN_PATTERNS.md](./FORBIDDEN_PATTERNS.md) | AI 금지 코드 패턴 12종 카탈로그 |
| [DATA_CLASSIFICATION.md](./DATA_CLASSIFICATION.md) | 진학어플라이 데이터 분류 및 처리 기준 |
| [INCIDENT_RESPONSE.md](./INCIDENT_RESPONSE.md) | AI 보안 인시던트 대응 가이드 |
| [NIGHTBUILDER_SECURITY.md](./NIGHTBUILDER_SECURITY.md) | NightBuilder 보안 규칙 |
| [../SECURITY_ISMS.md](../SECURITY_ISMS.md) | ISMS 보안 가이드 (기존 문서) |
| [../CLAUDE.md](../CLAUDE.md) | JINHAK 전사 AI 개발 표준 메인 문서 |

---

*이 문서는 [JINHAK 전사 AI 개발 표준](../CLAUDE.md) v2.0의 보안 상세 문서입니다.*
