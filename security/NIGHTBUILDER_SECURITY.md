# NightBuilder 보안 규칙

<!-- jinhak_standard_version: 2.3 -->
<!-- document_type: security-nightbuilder -->
<!-- last_updated: 2026-02-20 -->

---

## 1. 개요

**NightBuilder**는 24시간 무인으로 동작하는 AI 자동 개발 환경을 의미합니다. 사람의 실시간 감독 없이 Claude Code가 코드를 생성하므로, 일반 AI 협업보다 **강화된 보안 가이드레일**이 필요합니다.

**목적:**
- NightBuilder 환경에서의 보안 위협을 사전 차단
- 자동 생성 코드의 품질과 안전성 보장
- 비정상 동작의 조기 탐지 및 자동 대응

**적용 조건:**
- Claude Code가 `--headless` 모드 또는 API를 통해 무인 실행되는 모든 환경
- 야간/주말 자동 개발 스케줄러
- CI/CD 파이프라인 내 AI 코드 생성 단계

---

## 2. 자동화 실행 제한

NightBuilder 환경에서는 다음 작업이 **명시적으로 금지**됩니다.

### 2.1 절대 금지 작업

| 금지 작업 | 이유 | 대안 |
|-----------|------|------|
| 프로덕션 배포 명령 실행 | 무인 환경에서 프로덕션 변경은 고위험 | PR 생성까지만 허용, 배포는 사람이 수행 |
| DB 스키마 변경 자동 실행 | 데이터 손실/서비스 장애 위험 | 마이그레이션 초안(SQL/코드)만 생성, 실행은 사람이 수행 |
| 환경 변수 변경 | 서비스 장애, 보안 설정 변경 위험 | 변경 필요 사항을 PR 코멘트로 기록 |
| 새로운 외부 API 연동 코드 자동 머지 | 데이터 유출, 의존성 증가 위험 | 코드 생성 후 반드시 사람이 리뷰 |
| 기존 보안 설정 파일 수정 | settings.json, CORS 설정 등 변경 위험 | 수정 필요 시 별도 이슈로 등록 |
| 인증/인가 로직 변경 | 접근 제어 무력화 위험 | 초안만 생성, 2인 이상 리뷰 필수 |

### 2.2 조건부 허용 작업

| 작업 | 조건 | 제한 |
|------|------|------|
| 새 파일 생성 | 지정된 디렉토리 내에서만 | `src/`, `tests/` 하위만 허용 |
| 기존 파일 수정 | 금지 패턴 미포함 | FORBIDDEN_PATTERNS 자동 스캔 통과 필수 |
| 패키지 설치 | 검증 기준 충족 | 주간 다운로드 10K+, CVE 0건 |
| 테스트 코드 생성 | 제한 없음 | 테스트 파일에 한해 자유 생성 |
| 문서 업데이트 | `.ai/`, `docs/` 내에서만 | 보안 문서 수정 금지 |

---

## 3. 모니터링

### 3.1 생성 코드량 제한

| 지표 | 상한선 | 초과 시 조치 |
|------|--------|-------------|
| 세션당 코드 생성량 | 1,000 LOC | 세션 자동 종료 |
| 세션당 파일 생성 수 | 20개 | 세션 자동 종료 |
| 세션당 파일 수정 수 | 50개 | 경고 + 모니터링 강화 |
| 일일 총 생성량 | 3,000 LOC | 당일 NightBuilder 중지 |

### 3.2 비정상 패턴 감지

다음 패턴이 감지되면 **즉시 세션을 종료**하고 보안 이벤트로 기록합니다.

| 비정상 패턴 | 설명 | 대응 |
|------------|------|------|
| 동일 파일 반복 수정 | 같은 파일을 5회 이상 연속 수정 | 세션 종료 + P3 인시던트 |
| 대량 파일 삭제 | 10개 이상 파일 삭제 시도 | 세션 종료 + P2 인시던트 |
| 프로젝트 외부 접근 | 프로젝트 디렉토리 밖 파일 접근 | 세션 종료 + P3 인시던트 |
| 네트워크 비정상 접근 | 허용되지 않은 외부 URL 접근 | 세션 종료 + P3 인시던트 |
| 금지 명령 실행 시도 | deny 규칙에 의해 차단된 명령 반복 시도 | 세션 종료 + P2 인시던트 |
| 장시간 무응답 | 30분 이상 진행 없음 | 세션 종료 |

### 3.3 세션 타임아웃

| 설정 | 값 | 비고 |
|------|-----|------|
| 세션 최대 실행 시간 | 4시간 | 초과 시 자동 종료 |
| 유휴 타임아웃 | 30분 | 작업 없이 30분 경과 시 종료 |
| 일일 최대 세션 수 | 3회 | 1일 최대 12시간 |
| 세션 간 쿨다운 | 15분 | 연속 실행 방지 |

---

## 4. 결과물 처리

### 4.1 브랜치 규칙

NightBuilder가 생성한 모든 코드는 **별도 브랜치**에서만 작업합니다.

**브랜치 네이밍:**
```
ai/nightbuilder/{날짜}/{작업-설명}

예시:
ai/nightbuilder/2026-02-20/user-profile-api
ai/nightbuilder/2026-02-20/dashboard-tests
```

**브랜치 규칙:**
- `main`, `master`, `develop` 브랜치에 직접 커밋 금지
- NightBuilder 브랜치에서 다른 NightBuilder 브랜치로의 머지 금지
- 브랜치 생성 시 최신 `main`에서 분기

### 4.2 자동 PR 생성

NightBuilder 세션 완료 시 자동으로 PR을 생성합니다.

**PR 필수 포함 항목:**
- 작업 요약 (자동 생성)
- 변경된 파일 목록
- 생성된 코드량 (LOC)
- 보안 스캔 결과 (통과/실패)
- NightBuilder 세션 로그 링크

**PR 라벨:**
- `ai-generated` - AI가 생성한 코드 포함
- `nightbuilder` - NightBuilder 자동 생성
- `needs-security-review` - 보안 리뷰 필요 (보안 관련 코드 포함 시)

### 4.3 리뷰 및 머지 규칙

| 조건 | 최소 리뷰어 | 추가 조건 |
|------|-----------|----------|
| 테스트 코드만 포함 | 1명 | 보안 스캔 통과 |
| 일반 기능 코드 | 2명 | 보안 스캔 통과 + 모든 테스트 통과 |
| 보안 관련 코드 | 2명 + 보안 담당자 | 보안 스캔 통과 + 수동 보안 리뷰 |
| DB 관련 코드 | 2명 + DBA | 스키마 변경 리뷰 |

**머지 전 필수 검증:**
1. CI 파이프라인 전체 통과 (빌드, 테스트, 린트)
2. 보안 스캔(ESLint security, Semgrep) 통과
3. 금지 패턴(FORBIDDEN_PATTERNS) 미포함 확인
4. 코드 커버리지 기준 충족 (신규 코드 80% 이상)
5. 최소 리뷰어 수 충족 및 승인 완료

---

## 5. 브랜치 전략 및 머지 규칙

### 5.1 브랜치 흐름

```
main (프로덕션)
  │
  ├── develop (개발 통합)
  │     │
  │     ├── feature/* (개발자 작업)
  │     │
  │     └── ai/nightbuilder/* (NightBuilder 작업)
  │           │
  │           └── PR → develop (리뷰 후 머지)
  │
  └── hotfix/* (긴급 수정)
```

### 5.2 NightBuilder 브랜치 정리

| 상태 | 조치 | 시점 |
|------|------|------|
| PR 머지 완료 | 브랜치 자동 삭제 | 머지 즉시 |
| PR 거부/닫힘 | 브랜치 7일 후 자동 삭제 | PR 닫힌 후 7일 |
| PR 미생성 (세션 실패) | 브랜치 3일 후 자동 삭제 | 세션 종료 후 3일 |
| 오래된 PR (14일 이상 리뷰 대기) | 팀 리드에게 알림 | 14일 경과 시 |

---

## 7. deep-plan 미수렴 시 비동기 위임 정책

NightBuilder 환경에서 `/deep-plan`이 3라운드 내 수렴하지 않으면, 교착 상태를 방지하기 위해 **비동기 위임 경로**를 사용합니다.

### 7.1 PENDING_PLANS.md 저장 형식

미수렴 계획은 `.ai/PENDING_PLANS.md`에 다음 형식으로 저장됩니다:

```markdown
## [보류] YYYY-MM-DD HH:mm - [작업요약]
- **상태**: 미수렴 (라운드 N, 가중 비율 NN.N%)
- **C6 Hard Gate**: 통과 / 실패 / 해당없음
- **저장된 계획서**: `.ai/plans/YYYY-MM-DD_HHmm_[작업요약].md`
- **사유**: [정체 / 라운드 초과 / C6 Hard Gate 실패]
- **마지막 비평 요약**: [주요 미달 항목 1~3개]
```

### 7.2 다음 세션 조치 흐름

다음 유인(사람 참여) 세션이 시작되면:

1. `session-briefing.cjs`가 `PENDING_PLANS.md`의 `[보류]` 항목을 자동 감지하여 경고 출력
2. 개발자가 보류 건을 확인하고 다음 중 하나를 선택:

| 조치 | 설명 | 방법 |
|------|------|------|
| **수정 후 진행** | 비평 피드백을 반영하여 계획 수정 후 구현 | `/deep-plan`으로 재실행 또는 수동 보완 |
| **현재 계획으로 진행** | 미수렴이지만 충분하다고 판단 | 계획서를 참고하여 바로 구현 시작 |
| **보류 유지** | 추가 검토/논의가 필요 | `PENDING_PLANS.md`에 유지, 다음 세션에서 재확인 |
| **폐기** | 계획이 더 이상 유효하지 않음 | `PENDING_PLANS.md`에서 해당 항목 삭제 |

3. 조치 완료 후 `PENDING_PLANS.md`의 해당 항목 상태를 업데이트 (해결됨/폐기됨)

### 7.3 NightBuilder 자동 동작 요약

```
/deep-plan 실행
    ↓
3라운드 내 수렴? → [예] → 정상 흐름 (계획서 저장 + 구현)
    ↓ [아니오]
PENDING_PLANS.md에 보류 저장
    ↓
계획서(.ai/plans/)도 현재 상태로 저장 (미수렴 표기)
    ↓
다음 태스크로 진행 (교착 방지)
    ↓
다음 유인 세션에서 session-briefing이 보류 건 안내
```

---

## 8. 관련 문서 참조

| 문서 | 설명 |
|------|------|
| [AI_SECURITY_GUARDRAILS.md](./AI_SECURITY_GUARDRAILS.md) | 7-Layer Defense 마스터 문서 |
| [FORBIDDEN_PATTERNS.md](./FORBIDDEN_PATTERNS.md) | AI 금지 코드 패턴 카탈로그 |
| [INCIDENT_RESPONSE.md](./INCIDENT_RESPONSE.md) | 인시던트 대응 가이드 |
| [DATA_CLASSIFICATION.md](./DATA_CLASSIFICATION.md) | 데이터 분류 및 처리 기준 |
| [../CLAUDE.md](../CLAUDE.md) | JINHAK 전사 AI 개발 표준 메인 문서 |
| [../.claude/skills/deep-plan/SKILL.md](../.claude/skills/deep-plan/SKILL.md) | /deep-plan 스킬 (가중치 비평 + Hard Gate) |

---

*이 문서는 [JINHAK 전사 AI 개발 표준](../CLAUDE.md) v2.3의 보안 상세 문서입니다.*
